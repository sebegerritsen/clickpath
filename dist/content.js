(()=>{"use strict";class t{constructor(t,e=0){this.currentStepIndex=0,this.overlay=null,this.tour=t,this.currentPageIndex=e,this.state={tourId:t.id,currentPageIndex:e,currentStepIndex:0,startedAt:Date.now(),lastActivityAt:Date.now()}}start(){console.log(`[ClickPath] Starting tour: ${this.tour.name}`),this.createOverlay(),this.showStep()}stop(){console.log(`[ClickPath] Stopping tour: ${this.tour.name}`),this.removeOverlay()}getState(){return{...this.state}}get currentPage(){return this.tour.pages[this.currentPageIndex]}get currentStep(){return this.currentPage.steps[this.currentStepIndex]}get totalSteps(){return this.currentPage.steps.length}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="clickpath-overlay",this.overlay.innerHTML='\n      <div class="clickpath-highlight" id="clickpathHighlight"></div>\n      <div class="clickpath-tooltip" id="clickpathTooltip">\n        <div class="clickpath-step-indicator"></div>\n        <h4 class="clickpath-title"></h4>\n        <p class="clickpath-content"></p>\n        <div class="clickpath-buttons">\n          <button class="clickpath-btn clickpath-btn-skip">Skip Tour</button>\n          <div class="clickpath-nav-buttons">\n            <button class="clickpath-btn clickpath-btn-back">Back</button>\n            <button class="clickpath-btn clickpath-btn-next clickpath-btn-primary">Next</button>\n          </div>\n        </div>\n      </div>\n    ',this.overlay.querySelector(".clickpath-btn-skip")?.addEventListener("click",()=>this.skip()),this.overlay.querySelector(".clickpath-btn-back")?.addEventListener("click",()=>this.prevStep()),this.overlay.querySelector(".clickpath-btn-next")?.addEventListener("click",()=>this.nextStep()),document.body.appendChild(this.overlay)}removeOverlay(){this.overlay&&(this.overlay.remove(),this.overlay=null)}showStep(){if(!this.overlay)return;const t=this.currentStep,e=this.overlay.querySelector("#clickpathHighlight"),o=this.overlay.querySelector("#clickpathTooltip");if(t.condition?.elementExists&&!document.querySelector(t.condition.elementExists))return void this.nextStep();let s=null;if(t.element&&(s=document.querySelector(t.element),!s&&t.elementFallback))for(const e of t.elementFallback)if(s=document.querySelector(e),s)break;if(s){const o=s.getBoundingClientRect(),i=this.tour.settings.spotlightPadding??8;e.style.display="block",e.style.top=o.top+window.scrollY-i+"px",e.style.left=o.left+window.scrollX-i+"px",e.style.width=`${o.width+2*i}px`,e.style.height=`${o.height+2*i}px`,"none"!==this.tour.settings.scrollBehavior&&s.scrollIntoView({behavior:this.tour.settings.scrollBehavior??"smooth",block:"center"}),t.interaction?.clickThrough?e.style.pointerEvents="none":e.style.pointerEvents="auto"}else e.style.display="none";const i=o.querySelector(".clickpath-title"),r=o.querySelector(".clickpath-content"),c=o.querySelector(".clickpath-step-indicator");i.textContent=t.title,r.innerHTML=t.content,c.textContent=`Step ${this.currentStepIndex+1} of ${this.totalSteps}`,this.positionTooltip(o,s,t.position);const n=o.querySelector(".clickpath-btn-back"),a=o.querySelector(".clickpath-btn-next"),l=o.querySelector(".clickpath-btn-skip");n.style.display=this.currentStepIndex>0?"block":"none",a.textContent=this.currentStepIndex===this.totalSteps-1?"Finish":"Next",l.style.display=this.tour.settings.allowSkip?"block":"none",this.state.currentStepIndex=this.currentStepIndex,this.state.lastActivityAt=Date.now()}positionTooltip(t,e,o){const s=t.getBoundingClientRect(),i=window.innerWidth,r=window.innerHeight,c=16;if(!e)return t.style.top=(r-s.height)/2+"px",void(t.style.left=(i-s.width)/2+"px");const n=e.getBoundingClientRect();let a,l,h=o||"auto";if("auto"===h){const t=n.top,e=r-n.bottom,o=n.left,a=i-n.right;h=e>=s.height+c?"bottom":t>=s.height+c?"top":a>=s.width+c?"right":o>=s.width+c?"left":"bottom"}switch(h){case"top":a=n.top+window.scrollY-s.height-c,l=n.left+window.scrollX+(n.width-s.width)/2;break;case"bottom":a=n.bottom+window.scrollY+c,l=n.left+window.scrollX+(n.width-s.width)/2;break;case"left":a=n.top+window.scrollY+(n.height-s.height)/2,l=n.left+window.scrollX-s.width-c;break;case"right":a=n.top+window.scrollY+(n.height-s.height)/2,l=n.right+window.scrollX+c;break;default:a=n.bottom+window.scrollY+c,l=n.left+window.scrollX}l=Math.max(c,Math.min(l,i-s.width-c)),a=Math.max(c,Math.min(a,r-s.height-c+window.scrollY)),t.style.top=`${a}px`,t.style.left=`${l}px`}nextStep(){this.currentStepIndex<this.totalSteps-1?(this.currentStepIndex++,this.showStep()):this.complete()}prevStep(){this.currentStepIndex>0&&(this.currentStepIndex--,this.showStep())}skip(){console.log(`[ClickPath] Tour skipped: ${this.tour.name}`),this.saveProgress("skipped"),this.stop()}complete(){console.log(`[ClickPath] Tour completed: ${this.tour.name}`),this.saveProgress("completed"),this.stop()}saveProgress(t){const e=`tour_completed_${this.tour.id}`;chrome.storage.local.set({[e]:{status:t,completedAt:Date.now(),version:this.tour.version}})}}new class{constructor(){this.tourEngine=null,this.tours=[],this.config={enableAutoStart:!0,enableHelpButton:!0},this.init()}async init(){console.log("[ClickPath] Content script initialized on:",window.location.href),await this.applyCachedTheme(),await this.loadFromCorporater(),0===this.tours.length&&await this.loadBundledTours(),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),this.config.enableAutoStart&&this.checkAutoStart(),this.config.enableHelpButton&&this.injectHelpButton()}async loadFromCorporater(){try{const t="/CorpoWebserver/api/clickpath/v1";console.log("[ClickPath] Fetching from Corporater API:",t);const e=await fetch(t,{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!e.ok)return void console.warn(`[ClickPath] API returned ${e.status}`);const o=await e.json();if(o&&o.length>0&&o[0].success){const t=o[0];if(console.log(`[ClickPath] Loaded config from Corporater for user: ${t.user}`),t.tours)try{const e=JSON.parse(`[${t.tours}]`);this.tours=e.filter(t=>"object"==typeof t&&null!==t&&"id"in t),console.log(`[ClickPath] Loaded ${this.tours.length} tours from API`),chrome.storage.local.set({cachedTours:this.tours})}catch(t){console.warn("[ClickPath] Failed to parse tours JSON:",t)}const e={primary:t.primary,primaryDark:t.primaryDark,primaryLight:t.primaryLight,background:t.background,text:t.text,textMuted:t.textMuted,success:t.successColor,warning:t.warning};this.applyTheme(e),chrome.storage.local.set({cachedColors:e}),this.config={enableAutoStart:t.enableAutoStart,enableHelpButton:t.enableHelpButton},chrome.storage.local.set({cachedConfig:this.config})}}catch(t){console.warn("[ClickPath] Failed to load from Corporater API:",t);const e=await chrome.storage.local.get(["cachedTours","cachedColors","cachedConfig"]);e.cachedTours&&(this.tours=e.cachedTours,console.log(`[ClickPath] Using ${this.tours.length} cached tours`)),e.cachedColors&&this.applyTheme(e.cachedColors),e.cachedConfig&&(this.config={...this.config,...e.cachedConfig})}}async applyCachedTheme(){try{const t=await chrome.storage.local.get("cachedColors");t.cachedColors&&this.applyTheme(t.cachedColors)}catch{}}applyTheme(t){const e=document.documentElement;t.primary&&e.style.setProperty("--clickpath-primary",t.primary),t.primaryDark&&e.style.setProperty("--clickpath-primary-dark",t.primaryDark),t.primaryLight&&e.style.setProperty("--clickpath-primary-light",t.primaryLight),t.background&&e.style.setProperty("--clickpath-background",t.background),t.text&&e.style.setProperty("--clickpath-text",t.text),t.textMuted&&e.style.setProperty("--clickpath-text-muted",t.textMuted),t.success&&e.style.setProperty("--clickpath-success",t.success),t.warning&&e.style.setProperty("--clickpath-warning",t.warning),console.log("[ClickPath] Applied theme colors:",t)}async loadBundledTours(){try{const t=await fetch(chrome.runtime.getURL("tours/example-tour.json"));if(t.ok){const e=await t.json();this.tours=[e],console.log("[ClickPath] Loaded bundled example tour")}}catch(t){console.error("[ClickPath] Failed to load bundled tours:",t)}}handleMessage(t,e,o){switch(t.type){case"PING":o({success:!0,data:{installed:!0}});break;case"START_TOUR":this.startTour(t.tourId),o({success:!0});break;case"STOP_TOUR":this.stopTour(),o({success:!0});break;case"GET_TOURS":o({success:!0,data:this.tours.map(t=>({id:t.id,name:t.name,description:t.description}))});break;case"GET_STATE":o({success:!0,data:this.tourEngine?.getState()??null});break;case"FETCH_TOURS_FROM_CORPORATER":return this.loadFromCorporater().then(()=>{o({success:!0,data:this.tours})}),!0;default:o({success:!1,error:"Unknown message type"})}return!0}checkAutoStart(){const t=window.location.href;for(const e of this.tours)if("auto"===e.trigger.mode&&e.pages.find(e=>this.matchUrl(t,e))&&e.trigger.autoConditions?.firstVisit){const t=`tour_completed_${e.id}`;chrome.storage.local.get(t,o=>{o[t]||(console.log(`[ClickPath] Auto-starting tour: ${e.name}`),setTimeout(()=>this.startTour(e.id),1e3))})}}matchUrl(t,e){switch(e.urlMatchMode){case"exact":return t===e.urlPattern;case"contains":default:return t.includes(e.urlPattern);case"regex":return new RegExp(e.urlPattern).test(t);case"glob":const o=e.urlPattern.replace(/\*/g,".*").replace(/\?/g,".");return new RegExp(`^${o}$`).test(t)}}startTour(e){const o=e?this.tours.find(t=>t.id===e):this.tours.find(t=>t.pages.some(t=>this.matchUrl(window.location.href,t)));if(!o)return void console.error(`[ClickPath] Tour not found: ${e||"for current page"}`);const s=window.location.href,i=o.pages.findIndex(t=>this.matchUrl(s,t));-1!==i?(this.stopTour(),this.tourEngine=new t(o,i),this.tourEngine.start()):console.warn(`[ClickPath] No matching page for current URL in tour: ${o.id}`)}stopTour(){this.tourEngine&&(this.tourEngine.stop(),this.tourEngine=null)}injectHelpButton(){const t=window.location.href;!this.tours.some(e=>e.pages.some(e=>this.matchUrl(t,e)))&&this.tours.length,document.querySelector(".clickpath-help-button")?.remove();const e=document.createElement("button");e.className="clickpath-help-button",e.innerHTML="?",e.title="Start guided tour (Ctrl+Shift+T)",e.addEventListener("click",()=>{const e=this.tours.find(e=>e.pages.some(e=>this.matchUrl(t,e)));e?this.startTour(e.id):this.tours.length>0&&this.startTour(this.tours[0].id)}),document.body.appendChild(e)}}})();
//# sourceMappingURL=content.js.map